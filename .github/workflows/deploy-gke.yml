name: Build and Push to Artifact Registry

on:
  push:
    branches: [master]
  workflow_dispatch:

env:
  GCP_PROJECT_ID: web-service-design
  GCP_REGION: us-east1
  ARTIFACT_REGISTRY: us-east1-docker.pkg.dev/web-service-design/threads

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker us-east1-docker.pkg.dev

      - name: Build and push Next.js
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/arm64
          push: true
          tags: |
            ${{ env.ARTIFACT_REGISTRY }}/nextjs:${{ github.sha }}
            ${{ env.ARTIFACT_REGISTRY }}/nextjs:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push ML Service
        uses: docker/build-push-action@v5
        with:
          context: ./ml-service
          platforms: linux/arm64
          push: true
          tags: |
            ${{ env.ARTIFACT_REGISTRY }}/ml-service:${{ github.sha }}
            ${{ env.ARTIFACT_REGISTRY }}/ml-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Update kustomization with SHA tags
        run: |
          sed -i "s/__GITHUB_SHA__/${{ github.sha }}/g" k8s/overlays/prod/kustomization.yaml
          cat k8s/overlays/prod/kustomization.yaml

      - name: Install gke-gcloud-auth-plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin

      - name: Setup kubectl with IAP tunnel
        run: |
          # Get kubeconfig from k0s cluster via IAP tunnel
          gcloud compute ssh threads-prod-vm \
            --zone=us-east1-b \
            --tunnel-through-iap \
            --command='sudo k0s kubeconfig admin' > kubeconfig.yaml

          # Update kubeconfig to use IAP tunnel
          sed -i 's|server: https://.*:6443|server: https://localhost:6443|g' kubeconfig.yaml
          export KUBECONFIG=$(pwd)/kubeconfig.yaml

          # Start IAP tunnel in background
          gcloud compute start-iap-tunnel threads-prod-vm 6443 \
            --local-host-port=localhost:6443 \
            --zone=us-east1-b &
          TUNNEL_PID=$!

          # Wait for tunnel to be ready
          sleep 10

          # Test connection
          kubectl get nodes

      - name: Deploy with kubectl apply
        run: |
          export KUBECONFIG=$(pwd)/kubeconfig.yaml
          kubectl apply -k k8s/overlays/prod
          kubectl rollout status deployment/nextjs -n threads --timeout=5m
          kubectl rollout status deployment/ml-service -n threads --timeout=5m

      - name: Prune old images
        run: |
          export KUBECONFIG=$(pwd)/kubeconfig.yaml
          # Get list of all images currently in use
          USED_IMAGES=$(kubectl get pods --all-namespaces -o jsonpath="{.items[*].spec.containers[*].image}" | tr -s '[[:space:]]' '\n' | sort | uniq)

          # SSH to VM and prune unused images
          gcloud compute ssh threads-prod-vm \
            --zone=us-east1-b \
            --tunnel-through-iap \
            --command="sudo k0s ctr images list -q | grep -v '<none>' | while read img; do
              if ! echo '$USED_IMAGES' | grep -q \"\$img\"; then
                echo \"Removing unused image: \$img\"
                sudo k0s ctr images rm \"\$img\" || true
              fi
            done"

      - name: Deployment summary
        run: |
          echo "### Deployment Summary ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Images built and pushed:" >> $GITHUB_STEP_SUMMARY
          echo "- \`nextjs:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`ml-service:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployed to k8s cluster via kubectl apply" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Old images pruned to reduce disk usage" >> $GITHUB_STEP_SUMMARY
