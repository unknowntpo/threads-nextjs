# Deployment Guide - Zeabur with PostgreSQL

This guide will help you deploy the Threads application to Zeabur with a managed PostgreSQL database.

## Prerequisites

- GitHub repository with the latest code
- Zeabur account (sign up at https://zeabur.com)
- Production-ready environment variables

## Architecture

```
┌─────────────────────────────────────────┐
│           Zeabur Project                │
│                                         │
│  ┌──────────────┐    ┌──────────────┐  │
│  │   Next.js    │───▶│  PostgreSQL  │  │
│  │  Application │    │   Database   │  │
│  └──────────────┘    └──────────────┘  │
│         │                               │
└─────────┼───────────────────────────────┘
          │
          ▼
   Public Internet
   (https://your-app.zeabur.app)
```

## Step 1: Prepare Environment Variables

Create a `.env.production` file locally (don't commit!) with your production values:

```bash
# Database (will be auto-generated by Zeabur PostgreSQL service)
DATABASE_URL="postgresql://user:password@host:port/database"

# NextAuth
NEXTAUTH_SECRET="<generate-with-openssl-rand-base64-32>"
NEXTAUTH_URL="https://your-app.zeabur.app"

# OAuth Providers (optional)
GOOGLE_CLIENT_ID="your-google-client-id"
GOOGLE_CLIENT_SECRET="your-google-client-secret"
GITHUB_CLIENT_ID="your-github-client-id"
GITHUB_CLIENT_SECRET="your-github-client-secret"

# App Settings
NEXT_PUBLIC_APP_URL="https://your-app.zeabur.app"
NODE_ENV="production"
```

### Generate NextAuth Secret

```bash
openssl rand -base64 32
```

## Step 2: Create Zeabur Project

1. Go to https://zeabur.com and sign in
2. Click **"Create Project"**
3. Name your project (e.g., "threads-app")
4. Select your region (choose closest to your users)

## Step 3: Add PostgreSQL Service

1. In your Zeabur project, click **"Add Service"**
2. Select **"PostgreSQL"** from the marketplace
3. Zeabur will automatically provision a PostgreSQL database
4. Wait for the database to be ready (status: Running)
5. Click on the PostgreSQL service to view connection details
6. Note the **Connection String** - this is your `DATABASE_URL`

## Step 4: Deploy Next.js Application

### Option A: Deploy from GitHub (Recommended)

1. In your Zeabur project, click **"Add Service"**
2. Select **"Git"**
3. Connect your GitHub account if not already connected
4. Select your repository: `unknowntpo/threads_supabase`
5. Select branch: `master`
6. Zeabur will auto-detect it's a Next.js project

### Option B: Deploy from Docker (Alternative)

1. Ensure you have a `Dockerfile` in your repo
2. Select **"Docker"** when adding service
3. Point to your repository

## Step 5: Configure Environment Variables

1. Click on your Next.js service in Zeabur
2. Go to **"Variables"** or **"Environment"** tab
3. Add all environment variables from Step 1:

**Required Variables:**

```
DATABASE_URL = <copy from PostgreSQL service>
NEXTAUTH_SECRET = <your generated secret>
NEXTAUTH_URL = https://your-app.zeabur.app
NODE_ENV = production
```

**Optional OAuth Variables:**

```
GOOGLE_CLIENT_ID = <if using Google login>
GOOGLE_CLIENT_SECRET = <if using Google login>
GITHUB_CLIENT_ID = <if using GitHub login>
GITHUB_CLIENT_SECRET = <if using GitHub login>
```

**Important:** Zeabur automatically provides the `DATABASE_URL` from the PostgreSQL service. You can reference it using:

```
DATABASE_URL = ${POSTGRES_URL}
```

## Step 6: Run Database Migrations

After deployment, you need to run Prisma migrations:

### Method 1: Using Zeabur Console (Recommended)

1. Click on your Next.js service
2. Go to **"Console"** or **"Terminal"** tab
3. Run:

```bash
npx prisma migrate deploy
npx prisma db seed  # Optional: seed initial data
```

### Method 2: Using GitHub Actions

Add a migration step to your CI/CD:

```yaml
# .github/workflows/deploy.yml
- name: Run Prisma Migrations on Zeabur
  env:
    DATABASE_URL: ${{ secrets.ZEABUR_DATABASE_URL }}
  run: |
    npx prisma migrate deploy
```

## Step 7: Configure Build Settings

Zeabur should auto-detect your build settings, but verify:

**Build Command:**

```bash
npm run build
# or
pnpm build
```

**Start Command:**

```bash
npm start
# or
pnpm start
```

**Install Command:**

```bash
npm install
# or
pnpm install
```

## Step 8: Deploy and Verify

1. Click **"Deploy"** or push to `master` branch
2. Wait for build to complete (~2-5 minutes)
3. Zeabur will provide a public URL: `https://your-app-xxxxx.zeabur.app`
4. Click the URL to open your deployed app

## Step 9: Verify Deployment

Test all core features:

- [ ] **Home Page** loads correctly
- [ ] **Sign Up** creates new user account
- [ ] **Sign In** logs in existing user
- [ ] **Feed Page** displays after login
- [ ] **Create Post** form works
- [ ] **View Posts** in feed
- [ ] **Sign Out** returns to home
- [ ] **Database** persists data correctly

### Health Check Endpoints

Test these URLs:

```
https://your-app.zeabur.app                    # Home page
https://your-app.zeabur.app/auth/login         # Login page
https://your-app.zeabur.app/api/health         # Health check (if implemented)
```

## Step 10: Set Up Custom Domain (Optional)

1. In Zeabur project, click on your Next.js service
2. Go to **"Domain"** or **"Networking"** tab
3. Click **"Add Domain"**
4. Enter your custom domain (e.g., `threads.yourdomain.com`)
5. Add the CNAME record to your DNS provider:
   - Type: `CNAME`
   - Name: `threads` (or your subdomain)
   - Value: `your-app-xxxxx.zeabur.app`
6. Wait for DNS propagation (~5-30 minutes)
7. Update `NEXTAUTH_URL` and `NEXT_PUBLIC_APP_URL` to your custom domain

## Troubleshooting

### Build Fails

**Check logs in Zeabur console:**

1. Click on service → **"Logs"** tab
2. Look for error messages

**Common issues:**

- Missing environment variables → Add them in Zeabur
- Build timeout → Increase build resources in Zeabur settings
- Dependency errors → Clear cache and rebuild

### Database Connection Errors

**Symptoms:**

- "Error: P1001: Can't reach database server"
- "Connection refused"

**Solutions:**

1. Verify `DATABASE_URL` is correctly set
2. Check PostgreSQL service is running
3. Ensure services are in the same Zeabur project
4. Restart both services

### Migration Errors

**Symptoms:**

- "Table already exists"
- "Migration failed"

**Solutions:**

1. Check migration history: `npx prisma migrate status`
2. Reset database (CAUTION - deletes all data):
   ```bash
   npx prisma migrate reset --skip-seed
   npx prisma migrate deploy
   ```
3. Or manually fix migrations

### OAuth Redirect Issues

**Symptoms:**

- OAuth login redirects to wrong URL
- "Redirect URI mismatch"

**Solutions:**

1. Update OAuth app settings with production URL
2. Verify `NEXTAUTH_URL` matches deployed URL
3. Add Zeabur URL to authorized redirect URIs:
   - Google: `https://your-app.zeabur.app/api/auth/callback/google`
   - GitHub: `https://your-app.zeabur.app/api/auth/callback/github`

## CI/CD Automation

To enable automatic deployments on every push to `master`:

1. Zeabur automatically watches your GitHub repository
2. Any push to `master` triggers a new deployment
3. Configure branch protection rules on GitHub for safety

## Monitoring and Logs

### View Application Logs

1. Go to Zeabur project
2. Click on Next.js service
3. Click **"Logs"** tab
4. View real-time logs

### View Database Logs

1. Click on PostgreSQL service
2. Click **"Logs"** tab

### Metrics

1. Click on service
2. Click **"Metrics"** tab
3. View CPU, memory, network usage

## Production Checklist

Before going live:

- [ ] All environment variables configured
- [ ] Database migrations applied
- [ ] OAuth providers configured with production URLs
- [ ] All tests passing in CI
- [ ] Health checks working
- [ ] Backup strategy in place
- [ ] Custom domain configured (if needed)
- [ ] SSL/TLS enabled (automatic with Zeabur)
- [ ] Error monitoring set up (e.g., Sentry)
- [ ] Performance monitoring enabled

## Rollback

If deployment fails:

1. Go to Zeabur project
2. Click on Next.js service
3. Click **"Deployments"** tab
4. Select a previous successful deployment
5. Click **"Redeploy"**

## Support Resources

- **Zeabur Docs**: https://zeabur.com/docs
- **Prisma Deployment**: https://www.prisma.io/docs/guides/deployment
- **Next.js Deployment**: https://nextjs.org/docs/deployment
- **Zeabur Discord**: https://discord.gg/zeabur

## Next Steps

After successful deployment:

1. Monitor application performance
2. Set up database backups
3. Configure CDN for static assets (Zeabur handles this)
4. Add error tracking (Sentry, LogRocket, etc.)
5. Set up uptime monitoring (UptimeRobot, Pingdom, etc.)
6. Plan for scaling (Zeabur auto-scales)

---

🤖 Generated with [Claude Code](https://claude.com/claude-code)
